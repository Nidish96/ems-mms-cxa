using juliajim.HARMONIC

# * Setup System
function rocfun!(du, u, p, t)
    (; zt, w0, al, f, Om) = p;
    
    du[1] = u[2];
    du[2] = -w0^2*u[1]-2zt*w0*u[2] - al*u[1]^3 + f*cos(Om*t);
    return du;
end
  
# * Slow Flow
function sflow!(du, u, p, t=0.0)
    (; zt, w0, al, f, Om, typ, order) = p;

    if typ==:MMS
        if order==1
            du[1] = -(u[1]*zt*w0)-u[2]*(Om-w0)+3u[2]^3*al/8w0+3u[1]^2*u[2]*al/8w0;
            du[2] = -(u[2]*zt*w0)+u[1]*(Om-w0)-3u[1]*u[2]^2*al/8w0-(3u[1]^3*al)/8w0+f/2w0;
        elseif order==2
            sflow!(du, u, (;p..., order=1), t);
            du[1] += (-(128u[2]*zt^2*w0^4)+((96u[1]*u[2]^2+96u[1]^3)*al+64f)*zt*w0^2+(-(15u[2]^5)-30u[1]^2*u[2]^3-15u[1]^4*u[2])*al^2-48u[1]*u[2]*f*al)/256w0^3;
            du[2] += (128u[1]*zt^2*w0^4+(96u[2]^3+96u[1]^2*u[2])*al*zt*w0^2-64f*(Om-w0)*w0+(15u[1]*u[2]^4+30u[1]^3*u[2]^2+15u[1]^5)*al^2+(-72*u[2]^2-24*u[1]^2)*f*al)/256w0^3;
        elseif order==3
            sflow!(du, u, (;p..., order=2), t);
            du[1] += (3u[2]^3*al*zt^2)/16w0+(3u[1]^2*u[2]*al*zt^2)/16w0-(207u[1]*u[2]^4*al^2*zt)/512w0^3-(207u[1]^3*u[2]^2*al^2*zt)/256w0^3-(207u[1]^5*al^2*zt)/512w0^3-(3u[2]^2*f*al*zt)/32w0^3-(9u[1]^2*f*al*zt)/32w0^3-3u[1]*u[2]*f*al/16w0^3+(3u[1]*u[2]*f*Om*al)/16w0^4+(123u[2]^7*al^3)/8192w0^5+(369u[1]^2*u[2]^5*al^3)/8192w0^5+(369u[1]^4*u[2]^3*al^3)/8192w0^5+(123u[1]^6*u[2]*al^3)/8192w0^5+(9u[1]*u[2]^3*f*al^2)/32w0^5+(9u[1]^3*u[2]*f*al^2)/32w0^5;
            du[2] += -((3u[1]*u[2]^2*al*zt^2)/16w0)-(3u[1]^3*al*zt^2)/16w0-(207u[2]^5*al^2*zt)/512w0^3-(207u[1]^2*u[2]^3*al^2*zt)/256w0^3-(207u[1]^4*u[2]*al^2*zt)/512w0^3-(3u[1]*u[2]*f*al*zt)/16w0^3-9u[2]^2*f*al/32w0^3-3u[1]^2*f*al/32w0^3+(9u[2]^2*f*Om*al)/(32w0^4)+(3u[1]^2*f*Om*al)/(32w0^4)-(123u[1]*u[2]^6*al^3)/8192w0^5-(369u[1]^3*u[2]^4*al^3)/8192w0^5-(369u[1]^5*u[2]^2*al^3)/8192w0^5-(123u[1]^7*al^3)/8192w0^5+(621u[2]^4*f*al^2)/2048w0^5+(333u[1]^2*u[2]^2*f*al^2)/1024w0^5+(45*u[1]^4*f*al^2)/2048w0^5;
        end
    elseif typ==:EMS
        if order==1
            du[1] = u[2]*w0^2/2Om-u[1]*zt*w0+3u[2]^3*al/8Om+3u[1]^2*u[2]*al/8Om-u[2]*Om/2;
            du[2] = -u[1]*w0^2/2Om-u[2]*zt*w0-3u[1]*u[2]^2*al/8Om-3*u[1]^3*al/8Om+u[1]*Om/2+f/2Om;
        elseif order==2
            sflow!(du, u, (;p..., order=1), t);
            du[1] += -u[2]*w0^4/8Om^3-u[2]*zt^2*w0^2/2Om-3u[2]^3*al*w0^2/16Om^3-3u[1]^2*u[2]*al*w0^2/16Om^3+u[2]*w0^2/4Om+3u[1]*u[2]^2*al*zt*w0/8Om^2+3u[1]^3*al*zt*w0/8Om^2+f*zt*w0/4Om^2-15u[2]^5*al^2/256Om^3-15u[1]^2*u[2]^3*al^2/128Om^3-15u[1]^4*u[2]*al^2/256Om^3+3u[2]^3*al/16Om+3u[1]^2*u[2]*al/16Om-3u[1]*u[2]*f*al/16Om^3-u[2]*Om/8;
            du[2] += u[1]*w0^4/8Om^3+u[1]*zt^2*w0^2/2Om+3u[1]*u[2]^2*al*w0^2/16Om^3+3u[1]^3*al*w0^2/16Om^3-u[1]*w0^2/4Om-f*w0^2/8Om^3+3u[2]^3*al*zt*w0/8Om^2+3u[1]^2*u[2]*al*zt*w0/8Om^2+15u[1]*u[2]^4*al^2/256Om^3+15u[1]^3*u[2]^2*al^2/128Om^3+15u[1]^5*al^2/256Om^3-3u[1]*u[2]^2*al/16Om-3*u[1]^3*al/16Om-9u[2]^2*f*al/32Om^3-3u[1]^2*f*al/32Om^3+u[1]*Om/8+f/8Om;
        elseif order==3
            sflow!(du, u, (;p..., order=2), t);

            du[1] += u[2]*w0^6/16Om^5+u[2]*zt^2*w0^4/4Om^3+(9u[2]^3*al*w0^4)/64Om^5+(9u[1]^2*u[2]*al*w0^4)/64Om^5-(3u[2]*w0^4)/16Om^3-(3u[1]*u[2]^2*al*zt*w0^3)/(16*Om^4)-(3u[1]^3*al*zt*w0^3)/(16*Om^4)-(f*zt*w0^3)/(8*Om^4)+(3u[2]^3*al*zt^2*w0^2)/16Om^3+(3u[1]^2*u[2]*al*zt^2*w0^2)/16Om^3-u[2]*zt^2*w0^2/4Om+(45*u[2]^5*al^2*w0^2)/(512Om^5)+(45*u[1]^2*u[2]^3*al^2*w0^2)/(256*Om^5)+(45*u[1]^4*u[2]*al^2*w0^2)/(512Om^5)-(9u[2]^3*al*w0^2)/32Om^3-(9u[1]^2*u[2]*al*w0^2)/32Om^3+(3u[1]*u[2]*f*al*w0^2)/16Om^5+(3u[2]*w0^2)/16Om-(207*u[1]*u[2]^4*al^2*zt*w0)/(512Om^4)-(207*u[1]^3*u[2]^2*al^2*zt*w0)/256Om^4-(207*u[1]^5*al^2*zt*w0)/(512Om^4)+3u[1]*u[2]^2*al*zt*w0/(16*Om^2)+3u[1]^3*al*zt*w0/(16*Om^2)-(3u[2]^2*f*al*zt*w0)/(32Om^4)-(9u[1]^2*f*al*zt*w0)/(32Om^4)+f*zt*w0/8Om^2+(123*u[2]^7*al^3)/(8192Om^5)+(369u[1]^2*u[2]^5*al^3)/(8192Om^5)+(369u[1]^4*u[2]^3*al^3)/(8192Om^5)+(123*u[1]^6*u[2]*al^3)/(8192Om^5)-(45*u[2]^5*al^2)/(512Om^3)-(45*u[1]^2*u[2]^3*al^2)/256Om^3-(45*u[1]^4*u[2]*al^2)/(512Om^3)+(9u[1]*u[2]^3*f*al^2)/(32Om^5)+(9u[1]^3*u[2]*f*al^2)/(32Om^5)+(9u[2]^3*al)/(64*Om)+(9u[1]^2*u[2]*al)/(64*Om)-3u[1]*u[2]*f*al/16Om^3-u[2]*Om/16;
            du[2] += -((u[1]*w0^6)/16Om^5)-(u[1]*zt^2*w0^4)/4Om^3-(9u[1]*u[2]^2*al*w0^4)/64Om^5-(9u[1]^3*al*w0^4)/64Om^5+(3u[1]*w0^4)/16Om^3+(f*w0^4)/16Om^5-(3u[2]^3*al*zt*w0^3)/(16*Om^4)-(3u[1]^2*u[2]*al*zt*w0^3)/(16*Om^4)-(3u[1]*u[2]^2*al*zt^2*w0^2)/16Om^3-(3u[1]^3*al*zt^2*w0^2)/16Om^3+u[1]*zt^2*w0^2/4Om-(45*u[1]*u[2]^4*al^2*w0^2)/(512Om^5)-(45*u[1]^3*u[2]^2*al^2*w0^2)/(256*Om^5)-(45*u[1]^5*al^2*w0^2)/(512Om^5)+(9u[1]*u[2]^2*al*w0^2)/32Om^3+(9u[1]^3*al*w0^2)/32Om^3+(9u[2]^2*f*al*w0^2)/(32Om^5)+(3u[1]^2*f*al*w0^2)/(32Om^5)-(3u[1]*w0^2)/16Om-f*w0^2/8Om^3-(207*u[2]^5*al^2*zt*w0)/(512Om^4)-(207*u[1]^2*u[2]^3*al^2*zt*w0)/256Om^4-(207*u[1]^4*u[2]*al^2*zt*w0)/(512Om^4)+3u[2]^3*al*zt*w0/(16*Om^2)+3u[1]^2*u[2]*al*zt*w0/(16*Om^2)-(3u[1]*u[2]*f*al*zt*w0)/(16*Om^4)-(123u[1]*u[2]^6*al^3)/(8192Om^5)-(369u[1]^3*u[2]^4*al^3)/(8192Om^5)-(369u[1]^5*u[2]^2*al^3)/(8192Om^5)-(123*u[1]^7*al^3)/(8192Om^5)+(45*u[1]*u[2]^4*al^2)/(512Om^3)+(45*u[1]^3*u[2]^2*al^2)/256Om^3+(45*u[1]^5*al^2)/(512Om^3)+(621u[2]^4*f*al^2)/(2048*Om^5)+(333u[1]^2*u[2]^2*f*al^2)/(1024*Om^5)+(45*u[1]^4*f*al^2)/(2048*Om^5)-(9u[1]*u[2]^2*al)/(64*Om)-(9u[1]^3*al)/(64*Om)-9u[2]^2*f*al/32Om^3-3u[1]^2*f*al/32Om^3+u[1]*Om/16+f/16Om;
        end
    end

    return du;
end

function sflow_harms(u, p)
    (; zt, w0, al, f, Om, typ, order) = p;

    if typ==:MMS
        if order==1
            A3 = -(im*u[2]^3+3u[1]*u[2]^2-3im*u[1]^2*u[2]-u[1]^3)*al/32w0^2;
            A5 = 0im;
        elseif order==2
            A3, A5 = sflow_harms(u, (;p..., order=1));
            A3 += (3u[2]^3*al*zt)/64w0^2-(9im*u[1]*u[2]^2*al*zt)/64w0^2-(9u[1]^2*u[2]*al*zt)/64w0^2+(3im*u[1]^3*al*zt)/64w0^2+(21im*u[2]^5*al^2)/1024w0^4+(63u[1]*u[2]^4*al^2)/1024w0^4-(21im*u[1]^2*u[2]^3*al^2)/512w0^4+(21u[1]^3*u[2]^2*al^2)/512w0^4-(63im*u[1]^4*u[2]*al^2)/1024w0^4-(21u[1]^5*al^2)/1024w0^4-(9u[2]^2*f*al)/256w0^4+(9im*u[1]*u[2]*f*al)/128w0^4+(9u[1]^2*f*al)/256w0^4;
            A5 += (im*u[2]^5+5*u[1]*u[2]^4-10*im*u[1]^2*u[2]^3-10*u[1]^3*u[2]^2+5*im*u[1]^4*u[2]+u[1]^5)*al^2/1024w0^4;
        end
    elseif typ==:EMS
        if order==1
            A3 = -(im*u[2]^3+3u[1]*u[2]^2-3im*u[1]^2*u[2]-u[1]^3)*al/32Om^2;
            A5 = 0im;
        elseif order==2
            A3, A5 = sflow_harms(u, (;p..., order=1));
            A3 += (im*u[2]^3*al*w0^2)/32Om^4+(3u[1]*u[2]^2*al*w0^2)/32Om^4-(3im*u[1]^2*u[2]*al*w0^2)/32Om^4-(u[1]^3*al*w0^2)/32Om^4+(3u[2]^3*al*zt*w0)/64Om^3-(9im*u[1]*u[2]^2*al*zt*w0)/64Om^3-(9u[1]^2*u[2]*al*zt*w0)/64Om^3+(3im*u[1]^3*al*zt*w0)/64Om^3+(21im*u[2]^5*al^2)/1024Om^4+(63u[1]*u[2]^4*al^2)/1024Om^4-(21im*u[1]^2*u[2]^3*al^2)/512Om^4+(21u[1]^3*u[2]^2*al^2)/512Om^4-(63im*u[1]^4*u[2]*al^2)/1024Om^4-(21u[1]^5*al^2)/1024Om^4-(im*u[2]^3*al)/32Om^2-(3u[1]*u[2]^2*al)/32Om^2+(3im*u[1]^2*u[2]*al)/32Om^2+(u[1]^3*al)/32Om^2-(9u[2]^2*f*al)/256Om^4+(9im*u[1]*u[2]*f*al)/128Om^4+(9u[1]^2*f*al)/256Om^4;
            A5 += (im*u[2]^5+5*u[1]*u[2]^4-10*im*u[1]^2*u[2]^3-10*u[1]^3*u[2]^2+5*im*u[1]^4*u[2]+u[1]^5)*al^2/1024Om^4;
        end
    end
    return A3, A5
end

# * Harmonic Balance

function hbresfun!(du, u, p, h, N)
    (; zt, w0, al, f, Om) = p;
    
    E, _ = HARMONICSTIFFNESS(1.0, 2zt*w0, w0^2, Om, h);

    ut = AFT(u, h,N, :f2t);
    ft = al*ut.^3;
    Fnl = AFT(ft, h,N, :t2f);

    _, _, _, rinds, _ = HINDS(1, h);

    du[:] = E*u+Fnl;
    du[rinds[1]] -= f;

    return du;
end

# * Averaging Generating Function

